#!/bin/zsh

tc="./dist/build/tog/tog"

function bm_agda {
    hs_log=$(mktemp)
    agda_log=$(mktemp)
    timeout 60s agda -v0 -v profile:100 --allow-unsolved-metas --no-default-libraries -i ./agda-prelude/ -i "$(dirname $1)" --ignore-interfaces ${@:2} $1 +RTS -s$hs_log >!$agda_log 2>&1 
    code=$?

    echo "error:$code"
    cat $hs_log
    cat $agda_log

    rm -f $hs_log $agda_log
}

function pp_bm_agda {
    a=$(mktemp)
    cat > $a

    tid=$(cat $a | awk '/^\<Total   / { print $2 }')
    code=$(cat $a | awk 'match($0,/error:([0-9]+)/,data) { print data[1] }')

    cat $a | awk 'BEGIN { OFS="\t" }; /ms[^[:blank:]]*$/ { print "feature:" $1, "time:" $2; }' | while read line; do
        echo -e -n "$line\t"
        echo -e -n "error:$code\t"
        echo
    done

    rm -f $a
}

function bm_tog {
    tog_log=$(mktemp)

    timeout 60s $tc -q --fastGetAbsName --timeSections ${@:2} $1 >!$tog_log 2>&1
    code=$?

    echo "error:$code"
    cat $tog_log

    rm -f $tog_log
}

function pp_bm_tog {
    a=$(mktemp)
    cat > $a

    tid=$(cat $a | awk '/^\<Total   / { print $2 }')
    code=$(cat $a | awk 'match($0,/error:([0-9]+)/,data) { print data[1] }')

    cat $a | awk 'BEGIN { OFS="\t" }; /[^[:blank:]]+[[:blank:]]+[.,0-9]+ms\>/ { print "feature:" $1, "time:" $2; }' | while read line; do
        echo -e -n "$line\t"
        echo -e -n "error:$code\t"
        echo
    done

    rm -f $a
}

function add_prefix {
    a=$(cat $1)

    while read line; do
        echo "$a\t$line"
    done
}
